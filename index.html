<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Boating Conditions</title>

<style>
  body {
    margin:0;
    background:black;
    color:white;
    font-family:Arial, Helvetica, sans-serif;
  }

  .card{
    border:1px solid #333;
    border-radius:14px;
    padding:14px;
    background:rgba(255,255,255,0.06);
    max-width:420px;
    margin:0 auto;
  }

  h2 {
    margin:0 0 8px;
    font-size:22px;
    text-align:center;
  }

  .subhead{
    display:flex;
    justify-content:space-between;
    margin-bottom:8px;
    font-size:13px;
    opacity:.85;
  }

  /* NEW: section title line */
  .sectionTitle{
    margin:10px 0 8px;
    font-size:14px;
    font-weight:900;
    opacity:.9;
  }

  .stack{
    display:flex;
    flex-direction:column;
    gap:10px;
  }

  .slot{
    border:1px solid #2a2a2a;
    border-radius:12px;
    padding:10px;
    background:rgba(0,0,0,0.18);
  }

  .slotTop{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:6px;
  }

  .slotTime{
    font-size:15px;
    font-weight:800;
  }

  .badge{
    font-size:11px;
    font-weight:900;
    padding:3px 8px;
    border-radius:999px;
    border:1px solid currentColor;
    flex:0 0 auto;
  }

  /* 2x2 grid */
  .kv{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:8px 10px;
    font-size:13px;
    line-height:1.25;
  }

  /* label + value on ONE line */
  .cell{
    display:flex;
    gap:6px;
    align-items:baseline;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .k{
    opacity:.70;
    font-size:12px;
    font-weight:700;
    flex:0 0 auto;
  }
  .v{
    font-weight:800;
    flex:1 1 auto;
    min-width:0;
  }

  .good { color:#8fff9a; }
  .ok   { color:#ffd27d; }
  .bad  { color:#ff9a9a; }

  .legend{
    margin-top:10px;
    padding:10px;
    border:1px solid #2a2a2a;
    border-radius:12px;
    background:rgba(0,0,0,0.18);
    font-size:12px;
    line-height:1.35;
  }

  .legend .row{ margin-top:6px; }

  .legend .tag{
    display:inline-block;
    padding:2px 7px;
    border-radius:999px;
    border:1px solid currentColor;
    font-weight:900;
    font-size:11px;
    margin-right:6px;
  }

  .meta{
    margin-top:10px;
    padding-top:8px;
    border-top:1px solid #222;
    font-size:12px;
    opacity:.75;
    text-align:center;
  }

  .meta a{
    color:#9fd4ff;
    text-decoration:none;
  }
</style>
</head>

<body>
<div class="card">
  <h2>Boating Conditions</h2>

  <div class="subhead">
    <div>Somerset</div>
    <div id="nowLine">–</div>
  </div>

  <div class="sectionTitle">Today</div>
  <div id="slotsToday" class="stack"></div>

  <div class="sectionTitle">Tomorrow (best 3h window)</div>
  <div id="slotTomorrowBest" class="stack"></div>

  <div class="legend">
    <div><strong>Rating guide</strong></div>
    <div class="row good"><span class="tag">GOOD</span>Wind/gust ≤ <strong>18 km/h</strong>, rain ≤ <strong>35%</strong></div>
    <div class="row ok"><span class="tag">OK</span>Wind/gust ≤ <strong>26 km/h</strong>, rain ≤ <strong>60%</strong></div>
    <div class="row bad"><span class="tag">BAD</span>Stronger wind/gust or high rain risk</div>
  </div>

  <div class="meta">
    <div id="metaUpdated">Last updated: –</div>
    <div id="metaNext">Next update: –</div>
    <div>
      Source: <a href="https://open-meteo.com/" target="_blank">Open-Meteo</a>
    </div>
  </div>
</div>

<script>
const LAT = -27.1153;
const LON = 152.5565;
const TZ  = "Australia/Brisbane";

const WINDOW_HOURS = 3;
const DAY_SLOTS = [
  { start: 6,  end: 9  },
  { start: 9,  end: 12 },
  { start: 12, end: 15 },
  { start: 15, end: 18 }
];

const REFRESH_MS = 30 * 60 * 1000;

function waveProxy(kmh){
  if (kmh < 5) return 0;
  if (kmh < 10) return 10;
  if (kmh < 15) return 20;
  if (kmh < 20) return 35;
  if (kmh < 25) return 50;
  return 70;
}

function windDir(deg){
  const d=["N","NE","E","SE","S","SW","W","NW"];
  return d[Math.round((deg||0)/45)%8];
}

function fmtTime(d){
  return d.toLocaleTimeString("en-AU",{timeZone:TZ,hour:"2-digit",minute:"2-digit"});
}

function dayStr(offsetDays){
  return new Date(Date.now() + offsetDays*86400000).toLocaleDateString("en-CA",{timeZone:TZ});
}

function classify(e){
  const eff=Math.max(e.maxWind,e.maxGust);
  if(eff<=18 && e.maxProb<=35) return{label:"GOOD",cls:"good"};
  if(eff<=26 && e.maxProb<=60) return{label:"OK",cls:"ok"};
  return{label:"BAD",cls:"bad"};
}

/* lower score = better */
function score(e){
  return (e.avgWind*2.0) + (e.avgGust*3.0) + (e.maxProb*1.3) + (e.totalMm*80);
}

function findIndexForDayHour(t, dateStr, hour){
  const hh = String(hour).padStart(2,"0");
  return t.findIndex(x => x.startsWith(`${dateStr}T${hh}:00`));
}

function computeSlotMetrics(t, wind, gust, wd, prob, mm, dateStr, slot){
  const idx = findIndexForDayHour(t, dateStr, slot.start);
  if(idx < 0) return null;

  let maxWind=0,sumWind=0,maxGust=0,sumGust=0,maxProb=0,totalMm=0;
  for(let k=0;k<WINDOW_HOURS;k++){
    const w=wind[idx+k]||0;
    const g=gust[idx+k]||w;
    maxWind=Math.max(maxWind,w); sumWind+=w;
    maxGust=Math.max(maxGust,g); sumGust+=g;
    maxProb=Math.max(maxProb,prob[idx+k]||0);
    totalMm+=mm[idx+k]||0;
  }

  return {
    slot,
    avgWind: sumWind/WINDOW_HOURS,
    maxWind,
    avgGust: sumGust/WINDOW_HOURS,
    maxGust,
    maxProb,
    totalMm,
    dir: wd[idx]
  };
}

function renderSlot(containerEl, labelPrefix, e){
  const c = classify(e);
  const s = e.slot;
  const eff = Math.max(e.maxWind, e.maxGust);
  const wave = waveProxy(eff);

  const el = document.createElement("div");
  el.className = `slot ${c.cls}`;
  el.innerHTML = `
    <div class="slotTop">
      <div class="slotTime">${labelPrefix} ${String(s.start).padStart(2,"0")}:00 – ${String(s.end).padStart(2,"0")}:00</div>
      <div class="badge">${c.label}</div>
    </div>

    <div class="kv">
      <div class="cell"><span class="k">Wind</span><span class="v">${e.avgWind.toFixed(0)} / ${e.maxWind.toFixed(0)} km/h (${windDir(e.dir)})</span></div>
      <div class="cell"><span class="k">Gust</span><span class="v">${e.avgGust.toFixed(0)} / ${e.maxGust.toFixed(0)} km/h</span></div>
      <div class="cell"><span class="k">Wave</span><span class="v">~${wave} cm</span></div>
      <div class="cell"><span class="k">Rain</span><span class="v">≤ ${e.maxProb}% · ${e.totalMm.toFixed(1)} mm</span></div>
    </div>
  `;
  containerEl.appendChild(el);
}

async function load(){
  const now=new Date();
  document.getElementById("nowLine").textContent=`Now: ${fmtTime(now)}`;

  const r=await fetch(
    `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}`+
    `&hourly=wind_speed_10m,wind_gusts_10m,wind_direction_10m,precipitation_probability,precipitation`+
    `&timezone=${encodeURIComponent(TZ)}`,
    {cache:"no-store"}
  );
  const j=await r.json();

  const t=j.hourly.time;
  const wind=j.hourly.wind_speed_10m;
  const gust=j.hourly.wind_gusts_10m;
  const wd=j.hourly.wind_direction_10m;
  const prob=j.hourly.precipitation_probability;
  const mm=j.hourly.precipitation;

  const today = dayStr(0);
  const tomorrow = dayStr(1);

  // TODAY
  const todayWrap = document.getElementById("slotsToday");
  todayWrap.innerHTML = "";
  for(const s of DAY_SLOTS){
    const e = computeSlotMetrics(t, wind, gust, wd, prob, mm, today, s);
    if(!e) continue;
    renderSlot(todayWrap, "", e);
  }

  // TOMORROW BEST
  const tomWrap = document.getElementById("slotTomorrowBest");
  tomWrap.innerHTML = "";

  let best = null;
  for(const s of DAY_SLOTS){
    const e = computeSlotMetrics(t, wind, gust, wd, prob, mm, tomorrow, s);
    if(!e) continue;
    const sc = score(e);
    if(!best || sc < best.sc) best = { e, sc };
  }

  if(best && best.e){
    renderSlot(tomWrap, "Best:", best.e);
  } else {
    const el = document.createElement("div");
    el.className = "slot";
    el.textContent = "No forecast data for tomorrow yet.";
    tomWrap.appendChild(el);
  }

  document.getElementById("metaUpdated").textContent =
    `Last updated: ${now.toLocaleString("en-AU",{timeZone:TZ})}`;
  document.getElementById("metaNext").textContent =
    `Next update: ${new Date(now.getTime()+REFRESH_MS).toLocaleTimeString("en-AU",{timeZone:TZ})}`;
}

load();
setInterval(load,REFRESH_MS);
</script>
</body>
</html>
