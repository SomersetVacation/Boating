<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Boating Conditions</title>

<style>
  body {
    margin: 0;
    background: black;
    color: white;
    font-family: Arial, Helvetica, sans-serif;
  }

  .card {
    border: 1px solid #333;
    border-radius: 18px;
    padding: 24px 28px;
    background: rgba(255,255,255,0.06);
    max-width: 640px;
    margin: 0 auto;
    text-align: center;
  }

  h2 {
    margin: 0 0 14px;
    font-size: 34px;
  }

  .section {
    margin-top: 18px;
  }

  .label {
    font-size: 18px;
    opacity: 0.8;
  }

  .time {
    font-size: 36px;
    font-weight: bold;
    margin: 6px 0;
  }

  .detail {
    font-size: 18px;
    opacity: 0.85;
  }

  .good { color: #8fff9a; }
  .bad  { color: #ff9a9a; }
  .neutral { color: #ffd27d; }

  .meta {
    margin-top: 18px;
    padding-top: 14px;
    border-top: 1px solid #222;
    font-size: 14px;
    opacity: 0.75;
    line-height: 1.4;
  }

  .meta a{
    color:#9fd4ff;
    text-decoration:none;
  }
  .meta a:hover{ text-decoration:underline; }
</style>
</head>

<body>

<div class="card">
  <h2>Boating Conditions (3-hour windows)</h2>

  <div class="section">
    <div class="label">Best time today (3h)</div>
    <div id="bestToday" class="time good">–</div>
    <div id="bestTodayDetail" class="detail"></div>
  </div>

  <div class="section">
    <div class="label">Medium time today (3h)</div>
    <div id="mediumToday" class="time neutral">–</div>
    <div id="mediumTodayDetail" class="detail"></div>
  </div>

  <div class="section">
    <div class="label">Worst time today (3h)</div>
    <div id="worstToday" class="time bad">–</div>
    <div id="worstTodayDetail" class="detail"></div>
  </div>

  <div class="section">
    <div class="label">Best time tomorrow (3h)</div>
    <div id="bestTomorrow" class="time neutral">–</div>
    <div id="bestTomorrowDetail" class="detail"></div>
  </div>

  <div class="meta">
    <div id="metaLine1">Last updated: –</div>
    <div id="metaLine2">
      Source: <a href="https://open-meteo.com/" target="_blank" rel="noreferrer">Open-Meteo</a> (hourly forecast: wind + precipitation)
    </div>
    <div>Refresh: every 30 minutes</div>
  </div>
</div>

<script>
const LAT = -27.1153;
const LON = 152.5565;
const TZ = "Australia/Brisbane";

// 3-hour boating window (you can change this to 2 or 4 if you want)
const WINDOW_HOURS = 3;

// Inland wave proxy (cm)
function waveProxy(w) {
  if (w < 5) return 0;
  if (w < 10) return 10;
  if (w < 15) return 20;
  if (w < 20) return 35;
  if (w < 25) return 50;
  return 70;
}

function fmtTime(iso) {
  return new Date(iso).toLocaleTimeString("en-AU", {
    timeZone: TZ,
    hour: "2-digit",
    minute: "2-digit"
  });
}

function fmtNow() {
  return new Date().toLocaleString("en-AU", {
    timeZone: TZ,
    weekday: "short",
    hour: "2-digit",
    minute: "2-digit"
  });
}

function windDir(deg) {
  const dirs = ["N","NE","E","SE","S","SW","W","NW"];
  return dirs[Math.round(deg / 45) % 8];
}

// Lower score = better boating
function score(w, p, r) {
  return (w * 2) + (p * 1) + (r * 50);
}

async function load() {
  const apiUrl =
    `https://api.open-meteo.com/v1/forecast` +
    `?latitude=${LAT}&longitude=${LON}` +
    `&hourly=wind_speed_10m,wind_direction_10m,precipitation_probability,precipitation` +
    `&timezone=${encodeURIComponent(TZ)}`;

  const resp = await fetch(apiUrl, { cache: "no-store" });
  const j = await resp.json();

  const t = j.hourly.time;
  const w = j.hourly.wind_speed_10m;
  const wd = j.hourly.wind_direction_10m;
  const p = j.hourly.precipitation_probability;
  const rmm = j.hourly.precipitation;

  // Show “when updated” on screen (this is when your display fetched it)
  document.getElementById("metaLine1").textContent = `Last updated: ${fmtNow()}`;

  const today = new Date().toLocaleDateString("en-CA", { timeZone: TZ });
  const tomorrow = new Date(Date.now() + 86400000).toLocaleDateString("en-CA", { timeZone: TZ });

  // Build all candidate 3-hour windows for a given day
  function windowsFor(dateStr) {
    const list = [];
    for (let i = 0; i < t.length - WINDOW_HOURS; i++) {
      if (!t[i].startsWith(dateStr)) continue;

      const hour = new Date(t[i]).getHours();
      // Boating hours 6am–6pm (last window must fit)
      if (hour < 6 || hour > (18 - WINDOW_HOURS)) continue;

      let mw = 0, mp = 0, mr = 0, sc = 0, dir = wd[i];

      for (let k = 0; k < WINDOW_HOURS; k++) {
        mw = Math.max(mw, w[i + k] ?? 0);
        mp = Math.max(mp, p[i + k] ?? 0);
        mr += (rmm[i + k] ?? 0);
        sc += score(w[i + k] ?? 0, p[i + k] ?? 0, rmm[i + k] ?? 0);
      }

      list.push({ i, sc, mw, mp, mr, dir });
    }
    return list;
  }

  function pickBestMediumWorst(list) {
    if (!list || list.length === 0) return { best: null, medium: null, worst: null };
    const sorted = [...list].sort((a, b) => a.sc - b.sc);
    const best = sorted[0];
    const worst = sorted[sorted.length - 1];
    const medium = sorted[Math.floor(sorted.length / 2)]; // median quality
    return { best, medium, worst };
  }

  function fill(timeId, detailId, e) {
    if (!e) {
      document.getElementById(timeId).textContent = "–";
      document.getElementById(detailId).textContent = "";
      return;
    }

    const from = fmtTime(t[e.i]);
    const to = fmtTime(t[e.i + WINDOW_HOURS - 1]);

    document.getElementById(timeId).textContent = `${from} – ${to}`;

    document.getElementById(detailId).textContent =
      `Wind: ${e.mw.toFixed(0)} km/h (${windDir(e.dir)}) · ` +
      `Wave height: ~${waveProxy(e.mw)} cm · ` +
      `Rain chance: ≤ ${e.mp.toFixed(0)}%`;
  }

  // Today
  const todayWindows = windowsFor(today);
  const todayPick = pickBestMediumWorst(todayWindows);

  fill("bestToday", "bestTodayDetail", todayPick.best);
  fill("mediumToday", "mediumTodayDetail", todayPick.medium);
  fill("worstToday", "worstTodayDetail", todayPick.worst);

  // Tomorrow (best only)
  const tomWindows = windowsFor(tomorrow);
  const tomPick = pickBestMediumWorst(tomWindows);
  fill("bestTomorrow", "bestTomorrowDetail", tomPick.best);
}

load();
setInterval(load, 30 * 60 * 1000); // refresh every 30 minutes
</script>

</body>
</html>
