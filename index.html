<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Boating Conditions</title>

<style>
  body {
    margin: 0;
    background: black;
    color: white;
    font-family: Arial, Helvetica, sans-serif;
  }

  .card {
    border: 1px solid #333;
    border-radius: 18px;
    padding: 24px 28px;
    background: rgba(255,255,255,0.06);
    max-width: 580px;
    margin: 0 auto;
    text-align: center;
  }

  h2 {
    margin: 0 0 14px;
    font-size: 34px;
  }

  .section {
    margin-top: 20px;
  }

  .label {
    font-size: 18px;
    opacity: 0.8;
  }

  .time {
    font-size: 36px;
    font-weight: bold;
    margin: 6px 0;
  }

  .detail {
    font-size: 18px;
    opacity: 0.85;
  }

  .good { color: #8fff9a; }
  .bad  { color: #ff9a9a; }
  .neutral { color: #ffd27d; }

  .meta {
    margin-top: 18px;
    padding-top: 12px;
    border-top: 1px solid #222;
    font-size: 14px;
    opacity: 0.75;
    line-height: 1.35;
  }
  .meta a{
    color:#9fd4ff;
    text-decoration:none;
  }
  .meta a:hover{ text-decoration:underline; }
</style>
</head>

<body>

<div class="card">
  <h2>Boating Conditions</h2>

  <div class="section">
    <div class="label">Best time today (3h)</div>
    <div id="bestToday" class="time good">–</div>
    <div id="bestTodayDetail" class="detail"></div>
  </div>

  <div class="section">
    <div class="label">Worst time today (3h)</div>
    <div id="worstToday" class="time bad">–</div>
    <div id="worstTodayDetail" class="detail"></div>
  </div>

  <div class="section">
    <div class="label">Best time tomorrow (3h)</div>
    <div id="bestTomorrow" class="time neutral">–</div>
    <div id="bestTomorrowDetail" class="detail"></div>
  </div>

  <div class="meta">
    <div id="metaUpdated">Last updated: –</div>
    <div id="metaNext">Next update: –</div>
    <div id="metaSource">
      Source: <a href="https://open-meteo.com/" target="_blank" rel="noreferrer">Open-Meteo</a>
      (hourly forecast: wind + precipitation)
    </div>
  </div>
</div>

<script>
const LAT = -27.1153;
const LON = 152.5565;
const TZ = "Australia/Brisbane";
const WINDOW = 3;

const REFRESH_MS = 30 * 60 * 1000; // 30 minutes

// Inland wave proxy (cm)
function waveProxy(w) {
  if (w < 5) return 0;
  if (w < 10) return 10;
  if (w < 15) return 20;
  if (w < 20) return 35;
  if (w < 25) return 50;
  return 70;
}

function fmtTime(iso) {
  return new Date(iso).toLocaleTimeString("en-AU", {
    timeZone: TZ,
    hour: "2-digit",
    minute: "2-digit"
  });
}

function fmtClock(d) {
  return d.toLocaleString("en-AU", {
    timeZone: TZ,
    weekday: "short",
    hour: "2-digit",
    minute: "2-digit"
  });
}

function windDir(deg) {
  const dirs = ["N","NE","E","SE","S","SW","W","NW"];
  return dirs[Math.round(deg / 45) % 8];
}

function score(w, p, r) {
  return w * 2 + p + r * 50;
}

function setMetaTimes() {
  const now = new Date();
  const next = new Date(now.getTime() + REFRESH_MS);
  document.getElementById("metaUpdated").textContent = `Last updated: ${fmtClock(now)}`;
  document.getElementById("metaNext").textContent = `Next update: ${fmtClock(next)}`;
}

async function load() {
  setMetaTimes();

  const r = await fetch(
    `https://api.open-meteo.com/v1/forecast` +
    `?latitude=${LAT}&longitude=${LON}` +
    `&hourly=wind_speed_10m,wind_direction_10m,precipitation_probability,precipitation` +
    `&timezone=${encodeURIComponent(TZ)}`,
    { cache: "no-store" }
  );

  const j = await r.json();
  const t = j.hourly.time;
  const w = j.hourly.wind_speed_10m;
  const wd = j.hourly.wind_direction_10m;
  const p = j.hourly.precipitation_probability;
  const rmm = j.hourly.precipitation;

  const today = new Date().toLocaleDateString("en-CA", { timeZone: TZ });
  const tomorrow = new Date(Date.now()+86400000)
    .toLocaleDateString("en-CA", { timeZone: TZ });

  function bestWorst(dateStr) {
    let best=null, worst=null;

    for(let i=0;i<t.length-WINDOW;i++){
      if(!t[i].startsWith(dateStr)) continue;

      const hour = new Date(t[i]).getHours();
      // boating hours 6am–6pm, ensure window fits:
      if(hour < 6 || hour > (18 - WINDOW)) continue;

      let mw=0, mp=0, mr=0, sc=0, dir=wd[i];
      for(let k=0;k<WINDOW;k++){
        mw = Math.max(mw, w[i+k]);
        mp = Math.max(mp, p[i+k]);
        mr += rmm[i+k];
        sc += score(w[i+k], p[i+k], rmm[i+k]);
      }

      const e = {i, sc, mw, mp, mr, dir};
      if(!best || sc < best.sc) best = e;
      if(!worst || sc > worst.sc) worst = e;
    }
    return {best, worst};
  }

  function fill(tId, dId, e){
    if(!e) {
      document.getElementById(tId).textContent = "–";
      document.getElementById(dId).textContent = "";
      return;
    }

    // ✅ Correct 3-hour window: end = start + WINDOW hours
    const startDate = new Date(t[e.i]);
    const endDate = new Date(startDate.getTime() + WINDOW * 60 * 60 * 1000);

    document.getElementById(tId).textContent =
      `${fmtTime(startDate.toISOString())} – ${fmtTime(endDate.toISOString())}`;

    document.getElementById(dId).textContent =
      `Wind: ${e.mw.toFixed(0)} km/h (${windDir(e.dir)}) · ` +
      `Wave height: ~${waveProxy(e.mw)} cm · ` +
      `Rain chance: ≤ ${e.mp}%`;
  }

  const tBW = bestWorst(today);
  const tmBW = bestWorst(tomorrow);

  fill("bestToday", "bestTodayDetail", tBW.best);
  fill("worstToday", "worstTodayDetail", tBW.worst);
  fill("bestTomorrow", "bestTomorrowDetail", tmBW.best);
}

load();
setInterval(load, REFRESH_MS);
</script>

</body>
</html>
